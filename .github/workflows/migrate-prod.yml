name: Migrate v1 to v2 (Production)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migration in'
        required: true
        type: choice
        default: 'staging'
        options:
          - staging
          - production
          - qa
      event:
        description: 'The event to process (birth or death)'
        required: true
        type: string
      domain:
        description: 'The environment domain (without protocol or subdomains)'
        required: true
        type: string
        default: 'farajaland.opencrvs.org'
      skip:
        description: 'Number of records to skip'
        required: false
        type: number
        default: 0

jobs:
  migrate:
    name: Migrate ${{ github.event.inputs.event }} in ${{ github.event.inputs.environment }} (${{ github.event.inputs.domain }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    outputs:
      script_output: ${{ steps.deno-script.outputs.script_output }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: Update apt
        run: sudo apt update

      - name: Install openconnect
        run: sudo apt install -y openconnect

      - name: Install virtualenv
        run: |
          sudo apt install virtualenvwrapper
          sudo apt install virtualenv
          virtualenv vpn-slice
          source vpn-slice/bin/activate
          pip3 install https://github.com/dlenski/vpn-slice/archive/master.zip

      - name: Connect to VPN
        run: |
          # Store original resolv.conf
          sudo cp /etc/resolv.conf /etc/resolv.conf.backup

          # Connect to VPN - redirect stderr to capture DNS info
          echo "${{ secrets.VPN_PWD }}" | sudo openconnect --syslog -u ${{ secrets.VPN_USER }} --passwd-on-stdin --protocol=${{ secrets.VPN_PROTOCOL }} ${{ secrets.VPN_HOST }}:${{ secrets.VPN_PORT }} --servercert ${{ secrets.VPN_SERVERCERT }} --background -v --no-dtls 2>&1 | tee /tmp/vpn-connect.log &

          # Wait for VPN to establish
          sleep 10

          # Extract DNS servers from VPN connection logs
          VPN_DNS=$(grep -oP '(?<=DNS: )[\d.]+' /tmp/vpn-connect.log | head -1)

          # If VPN DNS found, configure it
          if [ ! -z "$VPN_DNS" ]; then
            echo "Found VPN DNS: $VPN_DNS"
            echo "nameserver $VPN_DNS" | sudo tee /etc/resolv.conf > /dev/null
            cat /etc/resolv.conf.backup | grep -v nameserver | sudo tee -a /etc/resolv.conf > /dev/null
          fi

          # Setup routes
          ip_addr=$(ip -f inet addr show tun0 |sed -En -e 's/.*inet ([0-9.]+).*/\1/p')
          if [ ! -z "$ip_addr" ]; then
            # Add route only if it doesn't exist
            if ! ip route show | grep -q "10.17.30.0/24"; then
              echo "Adding route for 10.17.30.0/24..."
              sudo ip route add 10.17.30.0/24 via $ip_addr dev tun0
            else
              echo "Route for 10.17.30.0/24 already exists"
            fi
          fi

      - name: Configure DNS and test VPN connection
        run: |
          SSH_HOST="${{ vars.SSH_HOST || secrets.SSH_HOST }}"

          echo "Testing IP connectivity to $SSH_HOST..."
          ping -c4 $SSH_HOST

          # Configure /etc/hosts with SSH_HOST IP
          # All OpenCRVS subdomains (gateway, config, countryconfig, auth) point to the same IP as SSH_HOST
          echo "Configuring /etc/hosts with OpenCRVS domain mappings..."
          echo "$SSH_HOST gateway.${{ github.event.inputs.domain }}" | sudo tee -a /etc/hosts
          echo "$SSH_HOST config.${{ github.event.inputs.domain }}" | sudo tee -a /etc/hosts
          echo "$SSH_HOST countryconfig.${{ github.event.inputs.domain }}" | sudo tee -a /etc/hosts
          echo "$SSH_HOST auth.${{ github.event.inputs.domain }}" | sudo tee -a /etc/hosts

          echo "Final /etc/hosts entries for OpenCRVS:"
          grep "${{ github.event.inputs.domain }}" /etc/hosts

          echo "Testing DNS resolution..."
          nslookup gateway.${{ github.event.inputs.domain }} || echo "DNS lookup via /etc/hosts"

          echo "Testing HTTP connectivity to gateway..."
          curl -v --max-time 10 http://gateway.${{ github.event.inputs.domain }}/ping || echo "HTTP connection test completed"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          curl -fsSL https://deno.land/install.sh | sh
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

      - name: Convert notebook to TypeScript
        run: |
          mkdir -p tmp
          bash ./scripts/deno-notebook-to-deno.sh ./v1-to-v2-data-migration/migrate.ipynb ./tmp/migrate.ts

      - name: Run the script with Deno
        id: deno-script
        env:
          OPENCRVS_EVENT: ${{ github.event.inputs.event }}
          OPENCRVS_DOMAIN: ${{ github.event.inputs.domain }}
          RECORD_SKIP: ${{ github.event.inputs.skip }}
          OPENCRVS_CLIENT_ID: ${{ secrets.OPENCRVS_CLIENT_ID }}
          OPENCRVS_CLIENT_SECRET: ${{ secrets.OPENCRVS_CLIENT_SECRET }}
        run: |
          set -o pipefail
          echo "script_output<<EOF" >> $GITHUB_OUTPUT
          deno run --allow-net --allow-env ./tmp/migrate.ts | tee /dev/stderr >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "## Notebook result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deno-script.outputs.script_output }}" >> $GITHUB_STEP_SUMMARY
